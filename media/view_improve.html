<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src ${cspSource} 'unsafe-inline'; style-src ${cspSource} 'unsafe-inline';">
  <title>Flowchart Preview</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: white;
      color: #333;
      overflow: hidden;
    }
    .header h2 {
      margin: 0 0 20px 0;
      color: #333;
    }
    .controls {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .button {
      background: #007acc;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    .button:hover {
      background: #005a9e;
    }
    .button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .zoom-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      background: #f0f0f0;
      padding: 5px 10px;
      border-radius: 6px;
      border: 1px solid #ddd;
    }
    .zoom-btn {
      background: #fff;
      border: 1px solid #ccc;
      width: 30px;
      height: 30px;
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: #333;
      transition: all 0.2s;
    }
    .zoom-btn:hover {
      background: #e6f3ff;
      border-color: #007acc;
    }
    .zoom-info {
      font-size: 12px;
      color: #666;
      min-width: 45px;
      text-align: center;
    }
    #canvas-container {
      border: 1px solid #ccc;
      background: white;
      overflow: auto;
      position: relative;
      height: calc(100vh - 200px);
    }
    #canvas {
      transform-origin: 0 0;
      transition: transform 0.2s ease;
      min-width: 100%;
      min-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .error {
      color: #d63384;
      background: #f8d7da;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #f5c2c7;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .code-display {
      background: #f8f9fa;
      padding: 15px;
      margin: 10px 0;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 12px;
      border-radius: 4px;
      border: 1px solid #dee2e6;
      white-space: pre-wrap;
      display: none;
    }
    .status {
      background: #e7f3ff;
      border: 1px solid #b3d9ff;
      color: #004085;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-size: 14px;
    }
    #canvas svg {
      max-width: none !important;
      height: auto !important;
    }
    .minimap {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 150px;
      height: 100px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #ccc;
      border-radius: 4px;
      z-index: 100;
      overflow: hidden;
      display: none;
    }
    .minimap-content {
      transform-origin: 0 0;
      transform: scale(0.1);
    }
    .minimap-viewport {
      position: absolute;
      border: 2px solid #007acc;
      background: rgba(0, 122, 204, 0.1);
      pointer-events: none;
    }
  </style>
  <script src="${raphaelUri}"></script>
  <script src="${flowchartUri}"></script>
</head>
<body>
  <div class="header">
    <h2>Python ÊµÅÁ®ãÂúñÈ†êË¶Ω</h2>
  </div>
  <div id="status" class="status">üîÑ Ê≠£Âú®ËºâÂÖ• flowchart.js...</div>
  <div class="controls">
    <button class="button" onclick="toggleCode()">È°ØÁ§∫/Èö±ËóèÂéüÂßãÁ¢º</button>
    <button class="button" onclick="downloadSVG()" id="downloadBtn" style="display: none;">‰∏ãËºâ SVG</button>
    <div class="zoom-controls">
      <div class="zoom-btn" onclick="zoomOut()" title="Á∏ÆÂ∞è">‚àí</div>
      <div class="zoom-info" id="zoomLevel">100%</div>
      <div class="zoom-btn" onclick="zoomIn()" title="ÊîæÂ§ß">+</div>
      <div class="zoom-btn" onclick="resetZoom()" title="ÈáçË®≠Á∏ÆÊîæ">‚åÇ</div>
      <div class="zoom-btn" onclick="fitToWindow()" title="ÈÅ©ÊáâË¶ñÁ™ó">‚äû</div>
    </div>
    <button class="button" onclick="toggleMinimap()" id="minimapToggle" style="display: none;">Ëø∑‰Ω†Âú∞Âúñ</button>
  </div>
  <div id="canvas-container">
    <div id="canvas"><div class="loading">Ê≠£Âú®ËºâÂÖ•ÊµÅÁ®ãÂúñ...</div></div>
    <div class="minimap" id="minimap">
      <div class="minimap-content" id="minimap-content"></div>
      <div class="minimap-viewport" id="minimap-viewport"></div>
    </div>
  </div>
  <div id="code-display" class="code-display">${escapedCode}</div>
  <script>
    const code = ${escapedCode};
    const vscode = acquireVsCodeApi();
    window.addEventListener('message', event => {
      if (event.data.type === 'highlight-id') {
        const id = event.data.id;
        document.querySelectorAll('g.element rect, g.element path').forEach(el => {
          el.setAttribute('fill', 'white');
        });
        const el = document.getElementById(id);
        if (el) el.setAttribute('fill', '#ffef9f');
      }
    });
    function extractIdLineMap() {
      const map = {};
      document.querySelectorAll('g.element').forEach(g => {
        const text = g.querySelector('text')?.textContent;
        const shape = g.querySelector('rect, path');
        const id = shape?.getAttribute('id');
        if (text && id) {
          const match = text.match(/^line (\d+):/);
          if (match) map[match[1]] = id;
        }
      });
      vscode.postMessage({ type: 'id-line-map', map });
    }
  </script>
</body>
</html>
